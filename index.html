<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ„Ø¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Updated layout with both elements on the same line -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 10px;">
        <button class="btn" id="createFolderBtn" disabled style="flex: 1; min-width: 0;">Ø§Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        <div style="flex: 1; min-width: 0;">
            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
            
            <!-- File upload area with dotted frame and interactive filling -->
            <div class="file-upload-area" id="fileUploadArea">
                <i>ğŸ“</i>
                <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</p>
                <p class="file-info">Ø³ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>
                <p class="file-name" id="fileNameDisplay">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø±ÙÙˆÙ‚</p>
            </div>
        </div>
    </div>
    
    <div class="unit-title-container">
        <label for="unitTitle" class="unit-title-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
        <input type="text" id="unitTitle" name="unitTitle" class="unit-title-input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ­Ø¯Ø©">
    </div>
    
    <div class="main-div" id="mainDiv">
        <!-- This area is empty for you to build manually -->
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
        <button id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù„Ø¯</button>
    </div>
    
    <script>
        let studentNames = []; // Array to store student names from Excel file
        
        // Make the file upload area button clickable
        document.getElementById('fileUploadArea').addEventListener('click', function() {
            document.getElementById('excelFile').click();
        });
        
        document.getElementById('excelFile').addEventListener('change', function() {
            if (this.files.length > 0) {
                const file = this.files[0];
                // Display file name in the upload area
                document.getElementById('fileNameDisplay').textContent = file.name;
                
                // Update the upload area style to show uploaded state
                const uploadArea = document.getElementById('fileUploadArea');
                uploadArea.classList.add('uploaded');
                
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('http://localhost:5000/upload_excel', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„: ' + data.error);
                        // Reset file display
                        document.getElementById('fileNameDisplay').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù';
                        uploadArea.classList.remove('uploaded');
                        // Keep create button disabled
                        document.getElementById('createFolderBtn').disabled = true;
                        return;
                    }
                    
                    studentNames = data.student_names || [];
                    
                    // Enable the create folder button after successful file upload
                    document.getElementById('createFolderBtn').disabled = false;
                    
                    // Update the file info text
                    document.querySelector('.file-info').textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${studentNames.length} Ø·Ø§Ù„Ø¨/Ø·Ø§Ù„Ø¨Ø©`;
                })
                .catch(error => {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„: ' + error.message);
                    // Reset file display
                    document.getElementById('fileNameDisplay').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                    uploadArea.classList.remove('uploaded');
                    // Keep create button disabled
                    document.getElementById('createFolderBtn').disabled = true;
                });
            }
        });
        
        let currentFolderId = null; // Store the folder ID after creation
        
        document.getElementById('createFolderBtn').addEventListener('click', function() {
            const unitTitle = document.getElementById('unitTitle').value;
            if (unitTitle.trim() === '') {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ­Ø¯Ø©');
                return;
            }
            
            if (studentNames.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Send the data to the backend to create folder structure
            fetch('http://localhost:5000/create_folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    unit_title: unitTitle,
                    student_names: studentNames
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.success) {
                    currentFolderId = data.folder_id;
                    
                    // Show success visual feedback
                    const createBtn = document.getElementById('createFolderBtn');
                    createBtn.classList.add('success');
                    
                    // Revert button style after a delay
                    setTimeout(() => {
                        createBtn.classList.remove('success');
                    }, 1500);
                    
                    // Enable the save button after folder creation
                    document.getElementById('saveBtn').disabled = false;
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    
                    alert(data.message);
                } else {
                    throw new Error('Unknown error occurred');
                }
            })
            .catch(error => {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª: ' + error.message);
            });
        });
        
        // Initially hide the save button
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('saveBtn').disabled = true;
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            if (!currentFolderId) {
                alert('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…" Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            // Download the created folder structure
            const unitTitle = document.getElementById('unitTitle').value;
            
            // Create a temporary link to download the zip file using the folder ID
            const downloadUrl = `http://localhost:5000/download_folders/${currentFolderId}`;
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            a.download = unitTitle + '.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯...`);
        });
    </script>
</body>
</html>
</body>
</html>